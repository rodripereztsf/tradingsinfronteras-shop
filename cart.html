<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carrito · TSF SHOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="tsf-header">
    <div class="tsf-header-inner">
      <div class="logo">
        <span class="logo-main">TSF</span>
        <span class="logo-sub">SHOP</span>
      </div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="index.html#colecciones">Colecciones</a>
        <a href="index.html#destacados">Destacados</a>
        <a href="cart.html" class="btn-cart">Carrito</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <h1>Tu carrito</h1>

    <ul id="cart-items" class="cart-items"></ul>

    <div class="cart-summary">
      <p>Total USD: <span id="cart-total">0.00</span></p>
    </div>

    <!-- BOTONES DE PAGO -->
    <div class="checkout-buttons">
      <button id="btn-stripe" class="btn-primary">
        Pagar en USD (Stripe)
      </button>

      <button id="btn-usdt" class="btn-secondary">
        Pagar con USDT (BEP20)
      </button>

      <button id="btn-mp" class="btn-primary">
        Pagar en ARS (Mercado Pago)
      </button>
    </div>
  </main>

  <footer class="tsf-footer">
    <p>© 2025 TSF SHOP · Trading Sin Fronteras</p>
  </footer>

  <!-- Script general de la tienda (API_BASE, USDT_WALLET, etc.) -->
  <script src="script.js"></script>

  <!-- Lógica específica del carrito -->
  <script>
    // Detectamos automáticamente la clave del carrito en localStorage
    // para no romper lo que ya estaba hecho.
    const POSSIBLE_CART_KEYS = ["tsf_cart", "cart", "carrito", "carritoTSF"];
    let CART_KEY = null;

    function detectCartKey() {
      for (const key of POSSIBLE_CART_KEYS) {
        const raw = localStorage.getItem(key);
        if (raw && raw !== "[]" && raw !== "null") {
          CART_KEY = key;
          return;
        }
      }
      // Si no hay ninguna, usamos una por defecto
      CART_KEY = POSSIBLE_CART_KEYS[0];
    }

    detectCartKey();

    function getCart() {
      const raw = localStorage.getItem(CART_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.error("Error parseando carrito:", e);
        return [];
      }
    }

    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    // ============================
    // CARGAR CARRITO EN LA PÁGINA
    // ============================
    function loadCart() {
      const cart = getCart();
      const container = document.getElementById("cart-items");
      const totalEl = document.getElementById("cart-total");

      container.innerHTML = "";
      let sum = 0;

      cart.forEach((item, index) => {
        sum += item.price * item.qty;

        const li = document.createElement("li");
        li.classList.add("cart-item");

        li.innerHTML = `
          <div>
            <strong>${item.name}</strong><br>
            Cantidad: ${item.qty}<br>
            Precio: USD ${item.price}
          </div>
          <button class="btn-secondary btn-remove" data-index="${index}">
            Eliminar
          </button>
        `;

        container.appendChild(li);
      });

      totalEl.textContent = sum.toFixed(2);

      // Asociar eventos a los botones "Eliminar"
      document.querySelectorAll(".btn-remove").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const idx = Number(e.target.getAttribute("data-index"));
          const currentCart = getCart();
          currentCart.splice(idx, 1);
          saveCart(currentCart);
          loadCart();
        });
      });
    }

    loadCart();

    // ============================
    // PAGO CON STRIPE (USD)
    // ============================
    document.getElementById("btn-stripe").addEventListener("click", async () => {
      const cart = getCart();
      if (!cart.length) {
        alert("El carrito está vacío");
        return;
      }

      try {
        const successUrl = window.location.origin + "/checkout-success-stripe.html";
        const cancelUrl = window.location.href;

        const response = await fetch(`${API_BASE}/api/create-stripe-checkout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: cart, successUrl, cancelUrl }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("No se pudo crear el pago con Stripe.");
          console.log(data);
        }
      } catch (e) {
        console.error(e);
        alert("Error al conectar con Stripe.");
      }
    });

    // ============================
    // PAGO CON USDT (BEP20)
    // ============================
    document.getElementById("btn-usdt").addEventListener("click", () => {
      alert(
        "Para pagar con USDT (BEP20) enviá el monto total a:\n\n" +
        USDT_WALLET +
        "\n\nLuego enviá el comprobante por WhatsApp o el canal que definamos."
      );
    });

    // ============================
    // PAGO CON MERCADO PAGO (ARS)
    // ============================
    document.getElementById("btn-mp").addEventListener("click", async () => {
      const cart = getCart();
      if (!cart.length) {
        alert("El carrito está vacío");
        return;
      }

      try {
        const successUrl = window.location.origin + "/checkout-success-mp.html";
        const cancelUrl = window.location.href;

        const response = await fetch(`${API_BASE}/api/create-mp-preference`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: cart, successUrl, cancelUrl }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("No se pudo crear el pago con Mercado Pago.");
          console.log(data);
        }
      } catch (e) {
        console.error(e);
        alert("Error al conectar con Mercado Pago.");
      }
    });
  </script>
</body>
</html>
