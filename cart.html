<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carrito · TSF SHOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="tsf-header">
    <div class="tsf-header-inner">
      <div class="logo">
        <span class="logo-main">TSF</span>
        <span class="logo-sub">SHOP</span>
      </div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="index.html#colecciones">Colecciones</a>
        <a href="index.html#destacados">Destacados</a>
        <a href="cart.html" class="btn-cart">Carrito</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <h1>Tu carrito</h1>

    <ul id="cart-items" class="cart-items"></ul>

    <div class="cart-summary">
      <p>Total USD: <span id="cart-total">0.00</span></p>
    </div>

    <div class="checkout-buttons">
      <button id="btn-stripe" class="btn-primary">
        Pagar en USD (Stripe)
      </button>

      <button id="btn-usdt" class="btn-secondary">
        Pagar con USDT (BEP20)
      </button>

      <button id="btn-mp" class="btn-primary">
        Pagar en ARS (Mercado Pago)
      </button>
    </div>
  </main>

  <footer class="tsf-footer">
    <p>© 2025 TSF SHOP · Trading Sin Fronteras</p>
  </footer>

  <!-- Configuración general (API_BASE, USDT_WALLET, etc.) -->
  <script src="script.js"></script>

  <!-- Lógica del carrito -->
  <script>
    // =======================================
    // DETECCIÓN AUTOMÁTICA DE LA KEY DEL CARRITO
    // =======================================
    let CART_KEY = null;

    function detectCartKey() {
      // Recorremos TODO localStorage y buscamos un array de objetos (tu carrito)
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        try {
          const raw = localStorage.getItem(key);
          if (!raw) continue;

          const parsed = JSON.parse(raw);

          if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === "object") {
            // Encontramos un candidato razonable de carrito
            console.log("Carrito detectado en localStorage key:", key);
            CART_KEY = key;
            return;
          }
        } catch (e) {
          // No era JSON, seguimos
          continue;
        }
      }

      // Si no encontramos nada, usamos una por defecto
      console.log("No se encontró carrito en localStorage. Usando key por defecto 'tsf_cart'.");
      CART_KEY = "tsf_cart";
    }

    detectCartKey();

    function getCart() {
      const raw = localStorage.getItem(CART_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error("Error parseando carrito:", e);
        return [];
      }
    }

    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    // =======================================
    // CARGAR CARRITO EN LA PÁGINA
    // =======================================
    function loadCart() {
      const cart = getCart();
      const container = document.getElementById("cart-items");
      const totalEl = document.getElementById("cart-total");

      container.innerHTML = "";
      let sum = 0;

      cart.forEach((item, index) => {
        const price = Number(item.price) || 0;
        const qty = Number(item.qty || item.quantity || 1);

        sum += price * qty;

        const li = document.createElement("li");
        li.classList.add("cart-item");

        li.innerHTML = `
          <div>
            <strong>${item.name || item.titulo || "Producto"}</strong><br>
            Cantidad: ${qty}<br>
            Precio: USD ${price.toFixed(2)}
          </div>
          <button class="btn-secondary btn-remove" data-index="${index}">
            Eliminar
          </button>
        `;

        container.appendChild(li);
      });

      totalEl.textContent = sum.toFixed(2);

      // Botones "Eliminar"
      document.querySelectorAll(".btn-remove").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const idx = Number(e.target.getAttribute("data-index"));
          const currentCart = getCart();
          currentCart.splice(idx, 1);
          saveCart(currentCart);
          loadCart();
        });
      });
    }

    loadCart();

    // =======================================
    // PAGO CON STRIPE (USD)
    // =======================================
    document.getElementById("btn-stripe").addEventListener("click", async () => {
      const cart = getCart();
      if (!cart.length) {
        alert("El carrito está vacío");
        return;
      }

      try {
        const successUrl = window.location.origin + "/checkout-success-stripe.html";
        const cancelUrl = window.location.href;

        const response = await fetch(`${API_BASE}/api/create-stripe-checkout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: cart, successUrl, cancelUrl }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("No se pudo crear el pago con Stripe.");
          console.log(data);
        }
      } catch (e) {
        console.error(e);
        alert("Error al conectar con Stripe.");
      }
    });

    // =======================================
    // PAGO CON USDT (BEP20)
    // =======================================
    document.getElementById("btn-usdt").addEventListener("click", () => {
      alert(
        "Para pagar con USDT (BEP20) enviá el monto total a:\n\n" +
        USDT_WALLET +
        "\n\nLuego enviá el comprobante por WhatsApp o el canal que definamos."
      );
    });

    // =======================================
    // PAGO CON MERCADO PAGO (ARS)
    // =======================================
    document.getElementById("btn-mp").addEventListener("click", async () => {
      const cart = getCart();
      if (!cart.length) {
        alert("El carrito está vacío");
        return;
      }

      try {
        const successUrl = window.location.origin + "/checkout-success-mp.html";
        const cancelUrl = window.location.href;

        const response = await fetch(`${API_BASE}/api/create-mp-preference`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: cart, successUrl, cancelUrl }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("No se pudo crear el pago con Mercado Pago.");
          console.log(data);
        }
      } catch (e) {
        console.error(e);
        alert("Error al conectar con Mercado Pago.");
      }
    });
  </script>
</body>
</html>
