<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin TSF SHOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: #020308;
      color: #fff;
    }

    .admin-wrapper {
      max-width: 1100px;
      margin: 80px auto;
      padding: 24px;
      background: #05060a;
      border-radius: 16px;
      border: 1px solid #222;
    }

    .admin-title {
      font-size: 1.8rem;
      margin-bottom: 16px;
    }

    .admin-subtitle {
      font-size: 0.9rem;
      opacity: 0.75;
      margin-bottom: 24px;
    }

    .admin-grid {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 24px;
    }

    .admin-card {
      background: #0b0d13;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #222;
    }

    .admin-card h2 {
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #222;
      text-align: left;
      vertical-align: middle;
    }

    .admin-table th {
      font-weight: 600;
      opacity: 0.9;
    }

    .admin-table tr:last-child td {
      border-bottom: none;
    }

    .admin-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #444;
      opacity: 0.9;
    }

    .admin-badge--active {
      border-color: #2ecc71;
      color: #2ecc71;
    }

    .admin-badge--inactive {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .admin-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.9rem;
    }

    .admin-form label {
      font-weight: 600;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .admin-form input,
    .admin-form textarea,
    .admin-form select {
      width: 100%;
      background: #05060a;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 6px 8px;
      color: #fff;
      font-family: inherit;
      font-size: 0.85rem;
    }

    .admin-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .admin-form small {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .admin-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid #f1c40f;
      color: #f1c40f;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      margin-top: 6px;
      transition: background 0.15s ease, color 0.15s ease,
        border-color 0.15s ease, opacity 0.15s ease;
    }

    .admin-btn:hover {
      background: #f1c40f;
      color: #000;
    }

    .admin-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .admin-btn--small {
      padding: 4px 10px;
      font-size: 0.75rem;
      margin-top: 0;
    }

    .admin-btn--danger {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .admin-btn--danger:hover {
      background: #e74c3c;
      color: #000;
    }

    .admin-login {
      max-width: 400px;
      margin: 120px auto;
      text-align: center;
      padding: 24px;
      border-radius: 16px;
      background: #05060a;
      border: 1px solid #222;
    }

    .admin-login input {
      width: 100%;
      margin-top: 12px;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #0b0d13;
      color: #fff;
      font-family: inherit;
    }

    .admin-login button {
      width: 100%;
    }

    .admin-message {
      font-size: 0.8rem;
      margin-top: 8px;
      opacity: 0.8;
    }

    /* Bloque imagen admin */
    .admin-image-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .admin-image-row-inner {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .admin-image-row-inner input[type="file"] {
      max-width: 200px;
      border-radius: 999px;
      padding: 6px 10px;
    }

    .admin-image-row-inner input[type="text"] {
      flex: 1;
    }

    .admin-image-status {
      font-size: 0.7rem;
      opacity: 0.75;
    }

    .admin-image-preview {
      margin-top: 6px;
      max-width: 100%;
      max-height: 140px;
      border-radius: 8px;
      border: 1px solid #222;
      object-fit: cover;
    }

    @media (max-width: 900px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="admin-login" class="admin-login">
    <h1>Admin TSF SHOP</h1>
    <p>Acceso solo para administradores.</p>
    <input
      id="admin-password"
      type="password"
      placeholder="Contrase√±a de admin"
    />
    <button class="admin-btn" onclick="handleAdminLogin()">Entrar</button>
    <div id="admin-login-msg" class="admin-message"></div>
  </div>

  <!-- PANEL -->
  <div id="admin-panel" class="admin-wrapper" style="display: none">
    <h1 class="admin-title">Panel de productos ‚Äì TSF SHOP</h1>
    <p class="admin-subtitle">
      Crea, edita y elimina productos. Los activos se muestran en la tienda; los
      que marques como <strong>destacados</strong> aparecer√°n en la secci√≥n
      ‚ÄúProductos destacados‚Äù.
    </p>

    <div class="admin-grid">
      <!-- LISTADO -->
      <section class="admin-card">
        <h2>Productos actuales</h2>
        <table class="admin-table" id="admin-products-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Tipo</th>
              <th>Activo</th>
              <th>Destacado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="admin-products-tbody">
            <tr>
              <td colspan="6">Cargando productos...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- FORMULARIO -->
      <section class="admin-card">
        <h2 id="form-title">Crear nuevo producto</h2>
        <form class="admin-form" onsubmit="handleSaveProduct(event)">
          <!-- hidden para id al editar -->
          <input type="hidden" id="p-id" />

          <div>
            <label for="p-name">Nombre</label>
            <input id="p-name" required />
          </div>

          <div>
            <label for="p-price">Precio (USD)</label>
            <input
              id="p-price"
              type="number"
              step="0.01"
              min="0"
              required
            />
            <small>Ejemplo: 49.9 ‚Üí se guarda como 4990 centavos.</small>
          </div>

          <div>
            <label for="p-type">Tipo de producto</label>
            <select id="p-type">
              <option value="course">Formaci√≥n / Curso</option>
              <option value="indicator">Indicador TradingView</option>
              <option value="bot">Bot / Robot</option>
              <option value="physical">Producto f√≠sico</option>
              <option value="other">Otro</option>
            </select>
          </div>

          <div>
            <label for="p-desc">Descripci√≥n corta</label>
            <textarea id="p-desc" rows="3"></textarea>
          </div>

          <!-- IMAGEN DEL PRODUCTO: upload + URL -->
          <div class="admin-image-row">
            <label>Imagen del producto (JPG o PNG)</label>
            <div class="admin-image-row-inner">
              <input
                type="file"
                id="p-img-file"
                accept="image/jpeg,image/png"
              />
              <input
                type="text"
                id="p-img"
                placeholder="URL de la imagen (se completa autom√°ticamente al subir)"
              />
            </div>
            <div id="p-img-status" class="admin-image-status">
              Pod√©s subir una imagen desde tu PC; guardaremos la URL autom√°tica.
            </div>
            <img
              id="p-img-preview"
              class="admin-image-preview"
              style="display:none;"
              alt="Vista previa"
            />
          </div>

          <div>
            <label for="p-active">Activo</label>
            <select id="p-active">
              <option value="true">S√≠, mostrar en la tienda</option>
              <option value="false">No, dejar oculto</option>
            </select>
          </div>

          <div>
            <label for="p-featured">¬øProducto destacado?</label>
            <select id="p-featured">
              <option value="true">
                S√≠, mostrar en la secci√≥n ‚ÄúProductos destacados‚Äù
              </option>
              <option value="false">No, solo en la tienda</option>
            </select>
          </div>

          <div>
            <label for="p-delivery">URL de acceso / contenido principal</label>
            <input
              id="p-delivery"
              placeholder="https://drive.google.com/..."
            />
            <small>
              Este enlace se usa en el mail de acceso al producto (por ejemplo
              carpeta de Drive, link privado, etc.).
            </small>
          </div>

          <div>
            <label for="p-email-body">Instructivo (HTML o texto)</label>
            <textarea
              id="p-email-body"
              rows="4"
              placeholder="Pasos, recomendaciones, detalles espec√≠ficos del producto..."
            ></textarea>
            <small>
              Este texto se incluye en el mail de acceso / bienvenida. Pod√©s
              usar HTML b√°sico (&lt;p&gt;, &lt;br&gt;, &lt;strong&gt;).
            </small>
          </div>

          <div>
            <label for="p-pdf">URL PDF instructivo (opcional)</label>
            <input
              id="p-pdf"
              placeholder="https://.../instructivo.pdf"
            />
            <small>
              Si lo complet√°s, en el mail aparecer√° un link para descargar el
              PDF.
            </small>
          </div>

          <button class="admin-btn" type="submit">
            Guardar producto
          </button>

          <small id="admin-form-msg" class="admin-message">
            Completa los datos y guard√° el producto. Luego podr√°s editarlo o
            eliminarlo desde la lista de la izquierda.
          </small>
        </form>
      </section>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD = "tsfadmin2025"; // c√°mbiala por la que quieras
    const API_BASE =
      "https://tradingsinfronteras-shop.vercel.app" || "";

    // üëâ COMPLET√Å ESTO CON TUS DATOS DE CLOUDINARY
    const CLOUDINARY_CLOUD_NAME = "drz056xod";      // ej: "dx123abcd"
    const CLOUDINARY_UPLOAD_PRESET = "tsf_shop";             // el preset unsigned
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    function handleAdminLogin() {
      const input = document.getElementById("admin-password");
      const msg = document.getElementById("admin-login-msg");

      if (input.value === ADMIN_PASSWORD) {
        document.getElementById("admin-login").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        loadAdminProducts();
      } else {
        msg.textContent = "Contrase√±a incorrecta.";
        input.value = "";
        input.focus();
      }
    }

    async function loadAdminProducts() {
      const tbody = document.getElementById("admin-products-tbody");
      tbody.innerHTML =
        '<tr><td colspan="6">Cargando productos...</td></tr>';

      try {
        const res = await fetch(`${API_BASE}/api/admin-products`);
        const data = await res.json();

        if (!data || !Array.isArray(data.products)) {
          throw new Error("Respuesta inv√°lida");
        }

        const products = data.products;
        if (!products.length) {
          tbody.innerHTML =
            '<tr><td colspan="6">No hay productos cargados.</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        products.forEach((p) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${p.name}</td>
            <td>USD ${(p.price_cents / 100).toFixed(2)}</td>
            <td>${p.type || "-"}</td>
            <td>
              <span class="admin-badge ${
                p.is_active
                  ? "admin-badge--active"
                  : "admin-badge--inactive"
              }">
                ${p.is_active ? "Activo" : "Oculto"}
              </span>
            </td>
            <td>${p.is_featured === false ? "No" : "S√≠"}</td>
            <td>
              <button class="admin-btn admin-btn--small" onclick="editProduct('${
                p.id
              }')">Editar</button>
              <button class="admin-btn admin-btn--small admin-btn--danger" onclick="deleteProduct('${
                p.id
              }')">Eliminar</button>
            </td>
          `;

          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          '<tr><td colspan="6">Error al cargar productos.</td></tr>';
      }
    }

    function resetForm() {
      document.getElementById("form-title").textContent =
        "Crear nuevo producto";
      document.getElementById("p-id").value = "";
      document.getElementById("p-name").value = "";
      document.getElementById("p-price").value = "";
      document.getElementById("p-type").value = "course";
      document.getElementById("p-desc").value = "";
      document.getElementById("p-img").value = "";
      document.getElementById("p-active").value = "true";
      document.getElementById("p-featured").value = "true";
      document.getElementById("p-delivery").value = "";
      document.getElementById("p-email-body").value = "";
      document.getElementById("p-pdf").value = "";
      document.getElementById("admin-form-msg").textContent =
        "Completa los datos y guard√° el producto.";

      // reset imagen
      const preview = document.getElementById("p-img-preview");
      const status = document.getElementById("p-img-status");
      if (preview) {
        preview.style.display = "none";
        preview.src = "";
      }
      if (status) {
        status.textContent =
          "Pod√©s subir una imagen desde tu PC; guardaremos la URL autom√°tica.";
      }
      const fileInput = document.getElementById("p-img-file");
      if (fileInput) fileInput.value = "";
    }

    // === SUBIDA DE IMAGEN A CLOUDINARY ===
    async function uploadImageFile(file) {
      const statusEl = document.getElementById("p-img-status");
      const urlInput = document.getElementById("p-img");
      const preview = document.getElementById("p-img-preview");

      if (!file) return;

      if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
        alert(
          "Falta configurar CLOUDINARY_CLOUD_NAME o CLOUDINARY_UPLOAD_PRESET en admin.html"
        );
        return;
      }

      try {
        statusEl.textContent = "Subiendo imagen...";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        const res = await fetch(CLOUDINARY_UPLOAD_URL, {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        if (!res.ok) {
          console.error("Cloudinary error:", data);
          throw new Error("Error al subir la imagen");
        }

        const imageUrl = data.secure_url;
        urlInput.value = imageUrl;
        statusEl.textContent = "Imagen subida correctamente.";
        if (preview) {
          preview.src = imageUrl;
          preview.style.display = "block";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent =
          "Error al subir la imagen. Revis√° la consola.";
      }
    }

    // Listener para input file
    document.addEventListener("DOMContentLoaded", () => {
      const fileInput = document.getElementById("p-img-file");
      if (fileInput) {
        fileInput.addEventListener("change", (e) => {
          const file = e.target.files && e.target.files[0];
          if (file) {
            uploadImageFile(file);
          }
        });
      }
    });

    async function handleSaveProduct(event) {
      event.preventDefault();

      const id = document.getElementById("p-id").value.trim();
      const name = document.getElementById("p-name").value.trim();
      const priceUsd = parseFloat(
        document.getElementById("p-price").value || "0"
      );
      const type = document.getElementById("p-type").value;
      const desc = document.getElementById("p-desc").value.trim();
      const img = document.getElementById("p-img").value.trim();
      const isActive =
        document.getElementById("p-active").value === "true";
      const isFeatured =
        document.getElementById("p-featured").value === "true";
      const delivery = document
        .getElementById("p-delivery")
        .value.trim();
      const emailBody = document
        .getElementById("p-email-body")
        .value.trim();
      const pdfUrl = document.getElementById("p-pdf").value.trim();

      if (!name || !priceUsd) {
        alert("Nombre y precio son obligatorios.");
        return;
      }

      const price_cents = Math.round(priceUsd * 100);

      const payload = {
        id: id || undefined,
        name,
        type,
        short_description: desc,
        price_cents,
        currency: "USD",
        image_url: img,
        is_active: isActive,
        is_featured: isFeatured,
        delivery_type: delivery ? "drive_link" : "none",
        delivery_value: delivery,
        email_body: emailBody,
        pdf_url: pdfUrl,
      };

      const msgEl = document.getElementById("admin-form-msg");
      msgEl.textContent = "Guardando producto...";

      try {
        const res = await fetch(`${API_BASE}/api/admin-products`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Error al guardar");
        }

        msgEl.textContent = "Producto guardado correctamente.";
        resetForm();
        loadAdminProducts();
      } catch (err) {
        console.error(err);
        msgEl.textContent =
          "Error al guardar el producto. Revisa la consola.";
      }
    }

    async function editProduct(id) {
      const res = await fetch(`${API_BASE}/api/admin-products`);
      const data = await res.json();
      if (!data || !Array.isArray(data.products)) return;

      const product = data.products.find((p) => p.id === id);
      if (!product) return;

      document.getElementById("form-title").textContent =
        "Editar producto";
      document.getElementById("p-id").value = product.id || "";
      document.getElementById("p-name").value = product.name || "";
      document.getElementById("p-price").value =
        product.price_cents != null
          ? (product.price_cents / 100).toFixed(2)
          : "";
      document.getElementById("p-type").value = product.type || "other";
      document.getElementById("p-desc").value =
        product.short_description || "";
      document.getElementById("p-img").value =
        product.image_url || "";
      document.getElementById("p-active").value = product.is_active
        ? "true"
        : "false";
      document.getElementById("p-featured").value =
        product.is_featured === false ? "false" : "true";
      document.getElementById("p-delivery").value =
        product.delivery_value || "";
      document.getElementById("p-email-body").value =
        product.email_body || "";
      document.getElementById("p-pdf").value = product.pdf_url || "";

      // preview de la imagen si existe
      const preview = document.getElementById("p-img-preview");
      const status = document.getElementById("p-img-status");
      if (product.image_url && preview) {
        preview.src = product.image_url;
        preview.style.display = "block";
        status.textContent =
          "Imagen cargada. Pod√©s cambiarla subiendo un archivo nuevo.";
      } else {
        if (preview) {
          preview.style.display = "none";
          preview.src = "";
        }
        if (status) {
          status.textContent =
            "Pod√©s subir una imagen desde tu PC; guardaremos la URL autom√°tica.";
        }
      }

      document.getElementById("admin-form-msg").textContent =
        "Editando producto. Guard√° los cambios o limpia el formulario para crear uno nuevo.";
    }

    async function deleteProduct(id) {
      if (
        !confirm(
          "¬øSeguro que quer√©s eliminar este producto? Esta acci√≥n no se puede deshacer."
        )
      ) {
        return;
      }

      const msgEl = document.getElementById("admin-form-msg");
      msgEl.textContent = "Eliminando producto...";

      try {
        const res = await fetch(`${API_BASE}/api/admin-products`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Error al eliminar");
        }

        msgEl.textContent = "Producto eliminado correctamente.";
        resetForm();
        loadAdminProducts();
      } catch (err) {
        console.error(err);
        msgEl.textContent =
          "Error al eliminar el producto. Revis√° la consola.";
      }
    }
  </script>
</body>
</html>
