<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin TSF SHOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    .admin-wrapper {
      max-width: 1100px;
      margin: 80px auto;
      padding: 24px;
      background: #05060a;
      border-radius: 16px;
      border: 1px solid #222;
    }
    .admin-title {
      font-size: 1.8rem;
      margin-bottom: 16px;
    }
    .admin-subtitle {
      font-size: 0.9rem;
      opacity: 0.75;
      margin-bottom: 24px;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 24px;
    }
    .admin-card {
      background: #0b0d13;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #222;
    }
    .admin-card h2 {
      font-size: 1.1rem;
      margin-bottom: 12px;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .admin-table th,
    .admin-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #222;
      text-align: left;
    }
    .admin-table th {
      font-weight: 600;
      opacity: 0.9;
    }
    .admin-table tr:last-child td {
      border-bottom: none;
    }
    .admin-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #444;
      opacity: 0.9;
    }
    .admin-badge--active {
      border-color: #2ecc71;
      color: #2ecc71;
    }
    .admin-badge--inactive {
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .admin-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.9rem;
    }
    .admin-form label {
      font-weight: 600;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .admin-form input,
    .admin-form textarea,
    .admin-form select {
      width: 100%;
      background: #05060a;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 6px 8px;
      color: #fff;
      font-family: inherit;
      font-size: 0.85rem;
    }
    .admin-form textarea {
      resize: vertical;
      min-height: 60px;
    }
    .admin-form small {
      font-size: 0.7rem;
      opacity: 0.7;
    }
    .admin-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid #f1c40f;
      color: #f1c40f;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .admin-btn.secondary {
      border-color: #888;
      color: #ccc;
      font-size: 0.75rem;
      padding: 4px 10px;
      margin-top: 0;
    }
    .admin-btn.danger {
      border-color: #e74c3c;
      color: #e74c3c;
      font-size: 0.75rem;
      padding: 4px 10px;
      margin-top: 0;
    }
    .admin-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .admin-login {
      max-width: 400px;
      margin: 120px auto;
      text-align: center;
      padding: 24px;
      border-radius: 16px;
      background: #05060a;
      border: 1px solid #222;
    }
    .admin-login input {
      width: 100%;
      margin-top: 12px;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #0b0d13;
      color: #fff;
      font-family: inherit;
    }
    .admin-login button {
      width: 100%;
    }
    .admin-message {
      font-size: 0.8rem;
      margin-top: 8px;
      opacity: 0.8;
    }
    @media (max-width: 900px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="admin-login" class="admin-login">
    <h1>Admin TSF SHOP</h1>
    <p>Acceso solo para administradores.</p>
    <input id="admin-password" type="password" placeholder="Contraseña de admin">
    <button class="admin-btn" onclick="handleAdminLogin()">Entrar</button>
    <div id="admin-login-msg" class="admin-message"></div>
  </div>

  <!-- Panel -->
  <div id="admin-panel" class="admin-wrapper" style="display:none;">
    <h1 class="admin-title">Panel de productos – TSF SHOP</h1>
    <p class="admin-subtitle">
      Creá, edita y eliminá productos. Los activos se muestran en la tienda.
    </p>

    <div class="admin-grid">
      <!-- LISTADO -->
      <section class="admin-card">
        <h2>Productos actuales</h2>
        <table class="admin-table" id="admin-products-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Tipo</th>
              <th>Activo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="admin-products-tbody">
            <tr>
              <td colspan="5">Cargando productos...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- FORMULARIO -->
      <section class="admin-card">
        <h2 id="admin-form-title">Crear nuevo producto</h2>
        <form class="admin-form" onsubmit="handleSubmitProduct(event)">
          <input id="p-id" type="hidden">

          <div>
            <label for="p-name">Nombre</label>
            <input id="p-name" required>
          </div>

          <div>
            <label for="p-price">Precio (USD)</label>
            <input id="p-price" type="number" step="0.01" min="0" required>
            <small>Ejemplo: 49.9 → se guarda como 4990 centavos.</small>
          </div>

          <div>
            <label for="p-type">Tipo de producto</label>
            <select id="p-type">
              <option value="course">Formación / Curso</option>
              <option value="indicator">Indicador TradingView</option>
              <option value="bot">Bot / Robot</option>
              <option value="physical">Producto físico</option>
              <option value="other">Otro</option>
            </select>
          </div>

          <div>
            <label for="p-desc">Descripción corta</label>
            <textarea id="p-desc" rows="3"></textarea>
          </div>

          <div>
            <label for="p-img">URL de imagen</label>
            <input id="p-img" placeholder="https://...">
          </div>

          <div>
            <label for="p-instructions">Instructivo (HTML o texto)</label>
            <textarea id="p-instructions" rows="4" placeholder="Pasos, recomendaciones, detalles específicos del producto..."></textarea>
            <small>Este texto se incluye en el mail de acceso y en la página privada.</small>
          </div>

          <div>
            <label for="p-pdf">URL PDF instructivo (opcional)</label>
            <input id="p-pdf" placeholder="https://.../instructivo.pdf">
            <small>Si lo completás, en el mail aparecerá un link para descargar el PDF.</small>
          </div>

          <div>
            <label for="p-active">Activo</label>
            <select id="p-active">
              <option value="true">Sí, mostrar en la tienda</option>
              <option value="false">No, dejar oculto</option>
            </select>
          </div>

          <button id="admin-submit-btn" class="admin-btn" type="submit">
            Guardar producto
          </button>
          <button
            id="admin-cancel-edit"
            type="button"
            class="admin-btn secondary"
            style="display:none;"
            onclick="cancelEdit()"
          >
            Cancelar edición
          </button>

          <small id="admin-form-msg" class="admin-message">
            Al guardar, el producto se almacena en la base de datos y, si está activo, aparece en la tienda.
          </small>
        </form>
      </section>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD = "tsfadmin2025";
    const ADMIN_TOKEN = "tsfadmin2025";
    const API_BASE = "https://tradingsinfronteras-shop.vercel.app";

    let currentProducts = [];
    let editingId = null;

    function handleAdminLogin() {
      const input = document.getElementById("admin-password");
      const msg = document.getElementById("admin-login-msg");

      if (input.value === ADMIN_PASSWORD) {
        document.getElementById("admin-login").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        loadAdminProducts();
      } else {
        msg.textContent = "Contraseña incorrecta.";
        input.value = "";
        input.focus();
      }
    }

    async function loadAdminProducts() {
      const tbody = document.getElementById("admin-products-tbody");
      tbody.innerHTML = '<tr><td colspan="5">Cargando productos...</td></tr>';

      try {
        const res = await fetch(`${API_BASE}/api/admin-products`, {
          headers: {
            "x-admin-token": ADMIN_TOKEN,
          },
        });
        const data = await res.json();

        if (!data || !Array.isArray(data.products)) {
          throw new Error("Respuesta inválida");
        }

        currentProducts = data.products;

        if (!currentProducts.length) {
          tbody.innerHTML = '<tr><td colspan="5">No hay productos.</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        currentProducts.forEach((p) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${p.name}</td>
            <td>USD ${(p.price_cents / 100).toFixed(2)}</td>
            <td>${p.type || "-"}</td>
            <td>
              <span class="admin-badge ${
                p.is_active ? "admin-badge--active" : "admin-badge--inactive"
              }">
                ${p.is_active ? "Activo" : "Oculto"}
              </span>
            </td>
            <td>
              <button class="admin-btn secondary" type="button"
                onclick="startEditProduct('${p.id}')">
                Editar
              </button>
              <button class="admin-btn danger" type="button"
                onclick="deleteProduct('${p.id}')">
                Eliminar
              </button>
            </td>
          `;

          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error cargando productos en admin:", err);
        tbody.innerHTML =
          '<tr><td colspan="5">Error al cargar productos.</td></tr>';
      }
    }

    function fillFormWithProduct(p) {
      document.getElementById("p-id").value = p.id || "";
      document.getElementById("p-name").value = p.name || "";
      document.getElementById("p-price").value =
        p.price_cents != null ? (p.price_cents / 100).toFixed(2) : "";
      document.getElementById("p-type").value = p.type || "other";
      document.getElementById("p-desc").value = p.short_description || "";
      document.getElementById("p-img").value = p.image_url || "";
      document.getElementById("p-instructions").value = p.instructions || "";
      document.getElementById("p-pdf").value = p.pdf_url || "";
      document.getElementById("p-active").value = p.is_active ? "true" : "false";
    }

    function resetForm() {
      editingId = null;
      document.getElementById("p-id").value = "";
      document.getElementById("p-name").value = "";
      document.getElementById("p-price").value = "";
      document.getElementById("p-type").value = "course";
      document.getElementById("p-desc").value = "";
      document.getElementById("p-img").value = "";
      document.getElementById("p-instructions").value = "";
      document.getElementById("p-pdf").value = "";
      document.getElementById("p-active").value = "true";
      document.getElementById("admin-form-title").textContent =
        "Crear nuevo producto";
      document.getElementById("admin-submit-btn").textContent =
        "Guardar producto";
      document.getElementById("admin-cancel-edit").style.display = "none";
      document.getElementById("admin-form-msg").textContent =
        "Al guardar, el producto se almacena en la base de datos y, si está activo, aparece en la tienda.";
    }

    function startEditProduct(id) {
      const p = currentProducts.find((prod) => prod.id === id);
      if (!p) return;

      editingId = id;
      fillFormWithProduct(p);
      document.getElementById("admin-form-title").textContent =
        "Editar producto";
      document.getElementById("admin-submit-btn").textContent =
        "Guardar cambios";
      document.getElementById("admin-cancel-edit").style.display = "inline-flex";
      document.getElementById("admin-form-msg").textContent =
        "Estás editando un producto existente. Guardá para aplicar cambios.";
    }

    function cancelEdit() {
      resetForm();
    }

    function handleSubmitProduct(event) {
      event.preventDefault();

      const id = document.getElementById("p-id").value || null;
      const name = document.getElementById("p-name").value.trim();
      const priceUsd = parseFloat(
        document.getElementById("p-price").value || "0"
      );
      const type = document.getElementById("p-type").value;
      const desc = document.getElementById("p-desc").value.trim();
      const img = document.getElementById("p-img").value.trim();
      const isActive = document.getElementById("p-active").value === "true";
      const instructions = document
        .getElementById("p-instructions")
        .value.trim();
      const pdfUrl = document.getElementById("p-pdf").value.trim();

      const price_cents = Math.round(priceUsd * 100);

      const payload = {
        id: editingId || id || undefined,
        name,
        price_cents,
        type,
        short_description: desc,
        image_url: img,
        is_active: isActive,
        instructions,
        pdf_url: pdfUrl,
      };

      const msg = document.getElementById("admin-form-msg");
      msg.textContent = "Guardando producto...";

      const method = editingId ? "PUT" : "POST";

      fetch(`${API_BASE}/api/admin-products`, {
        method,
        headers: {
          "Content-Type": "application/json",
          "x-admin-token": ADMIN_TOKEN,
        },
        body: JSON.stringify(payload),
      })
        .then((res) => res.json())
        .then((data) => {
          if (!data || !data.ok) {
            console.error("Error al guardar producto:", data);
            msg.textContent = "Error al guardar producto.";
            return;
          }

          msg.textContent = editingId
            ? "Producto actualizado correctamente."
            : "Producto creado correctamente.";

          resetForm();
          loadAdminProducts();
        })
        .catch((err) => {
          console.error("Error fetch guardar producto:", err);
          msg.textContent = "Error de conexión al guardar.";
        });
    }

    function deleteProduct(id) {
      if (!confirm("¿Seguro que querés eliminar este producto?")) return;

      const msg = document.getElementById("admin-form-msg");
      msg.textContent = "Eliminando producto...";

      fetch(`${API_BASE}/api/admin-products`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "x-admin-token": ADMIN_TOKEN,
        },
        body: JSON.stringify({ id }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (!data || !data.ok) {
            console.error("Error al eliminar producto:", data);
            msg.textContent = "Error al eliminar producto.";
            return;
          }
          msg.textContent = "Producto eliminado correctamente.";
          if (editingId === id) resetForm();
          loadAdminProducts();
        })
        .catch((err) => {
          console.error("Error fetch eliminar producto:", err);
          msg.textContent = "Error de conexión al eliminar.";
        });
    }
  </script>
</body>
</html>
